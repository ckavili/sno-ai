apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: snoai-menu-router
  namespace: openshift-gitops
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]

  generators:
    - matrix:
        generators:
          # Read menu selection from Git
          - git:
              repoURL: https://github.com/ckavili/sno-ai.git
              revision: main
              files:
                - path: gitops/menu/config.yaml

          # Define all menu options
          - list:
              elements:
                - menu: "1"
                  path: gitops/menu-options/option-1
                  name: full-rhoai
                - menu: "2"
                  path: gitops/menu-options/option-2
                  name: model-serving-granite
                - menu: "3"
                  path: gitops/menu-options/option-3
                  name: llm-serving-llamascout
                - menu: "4"
                  path: gitops/menu-options/option-4
                  name: custom-config

        # Only generate Application for the selected menu item
        selector:
          matchExpressions:
            - key: menu
              operator: In
              values: ["{{.selectedMenu}}"]

  template:
    metadata:
      name: 'snoai-{{.name}}'
      labels:
        snoai-menu-option: '{{.menu}}'
        app.kubernetes.io/name: sno-ai
        app.kubernetes.io/part-of: snoai-platform
    spec:
      project: default
      source:
        repoURL: '{{.git.repoURL}}'
        targetRevision: '{{.git.branch}}'
        path: '{{.path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: redhat-ods-operator
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
      ignoreDifferences:
        - group: "*"
          kind: "*"
          managedFieldsManagers:
            - kube-controller-manager
